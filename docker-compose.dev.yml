services:
  postgres:
    # 使用官方 pgvector 镜像
    image: pgvector/pgvector:pg17
    container_name: interview-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: interview_guide
    volumes:
      # 使用绑定挂载，数据持久化到本地目录
      - ./data/postgres:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8.0
    container_name: interview-redis-dev
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      # 使用绑定挂载，数据持久化到本地目录
      - ./data/redis:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  rustfs:
    image: rustfs/rustfs:latest
    container_name: interview-rustfs-dev
    environment:
      RUSTFS_ROOT_USER: rustfsadmin
      RUSTFS_ROOT_PASSWORD: rustfsadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      # 使用绑定挂载，数据持久化到本地目录
      - ./data/rustfs:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/health" ]
      interval: 5s
      timeout: 3s
      retries: 5

  createbucket:
    image: amazon/aws-cli:latest
    depends_on:
      rustfs:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: rustfsadmin
      AWS_SECRET_ACCESS_KEY: rustfsadmin
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      /bin/sh -c " aws --endpoint-url http://rustfs:9000 s3 mb s3://interview-guide || true; exit 0; "
